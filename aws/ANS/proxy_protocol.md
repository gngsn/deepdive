# Proxy Protocol

- μΈν„°λ„· ν”„λ΅ν† μ½μ€ μ†μ¤(μ»¤λ„¥μ…μ„ μ”μ²­ν•λ” κ³³)μ—μ„ λ©μ μ§€(μ»¤λ„¥μ…μ„ μ”μ²­λ°›λ” κ³³)λ΅ μ •λ³΄λ¥Ό μ „λ‹¬ν•λ” λ° μ‚¬μ©λ¨
- LBκ°€ μ—°κ²°μ„ μΆ…λ£ν•λ©΄ ν΄λΌμ΄μ–ΈνΈμ μ†μ¤ IP μ£Όμ†λ¥Ό λ³΄μ΅΄ν•  μ μ—†μ
- μ†μ¤/λ€μƒ IP μ£Όμ†μ™€ ν¬νΈ λ²νΈλ¥Ό μ „λ‹¬ν•κΈ° μ„ν•΄ Proxy Protocolμ„ μ‚¬μ©
- λ΅λ“ λ°Έλ°μ„λ” TCP λ°μ΄ν„°μ— ν”„λ΅μ‹ ν”„λ΅ν† μ½ ν—¤λ”λ¥Ό μ¶”κ°€
- Classic Load Balancer(TCP/SSL) λ° Network Load Balancer λ¨λ‘μ—μ„ μ‚¬μ©ν•  μ μμ

<br/><img src="./img/proxy_protocol_img1.png" alt="Proxy Protocol" width="30%"/><br/>

<br/><br/>


<table><tr><td colspan="2">

[π”— Preserving client IP address with Proxy protocol v2 and Network Load Balancer](https://aws.amazon.com/ko/blogs/networking-and-content-delivery/preserving-client-ip-address-with-proxy-protocol-v2-and-network-load-balancer/)

Proxy Protocolμ€ νΉμ • ν•μ‹μ„ λ”°λ¦„.

Proxy Protocolμ€ ν΄λΌμ΄μ–ΈνΈμ™€ μ„λ²„ κ°„μ μ›λ μ—°κ²° μ •λ³΄λ¥Ό λ³΄μ΅΄ν•κΈ° μ„ν•΄ μ‚¬μ©λ¨.

Proxy Protocolμ—λ” v1κ³Ό v2 λ‘ κ°€μ§€ λ²„μ „μ΄ μμΌλ©°, v2λ” λ” ν¨μ¨μ μ΄κ³  ν™•μ¥μ„±μ΄ μΆ‹μ.

</td></tr>
<tr>
<th>Proxy Protocol v1</th>
<th>Proxy Protocol v2</th>
</tr>
<tr><td>

Proxy Protocol v1μ€ ν…μ¤νΈ κΈ°λ°μ΄λ©°, λ‹¤μκ³Ό κ°™μ€ ν•μ‹μ„ κ°€μ§:

```
PROXY TCP4 198.51.100.1 203.0.113.1 56324 443\r\n
```

- `PROXY`: Proxy Protocolμ„ λ‚νƒ€λ‚΄λ” κ³ μ • λ¬Έμμ—΄
- `TCP4`: IPv4λ¥Ό μ‚¬μ©ν•λ” TCP μ—°κ²°
- `198.51.100.1`: μ›λ³Έ ν΄λΌμ΄μ–ΈνΈμ IP μ£Όμ†
- `203.0.113.1`: λ©μ μ§€ μ„λ²„μ IP μ£Όμ†
- `56324`: μ›λ³Έ ν΄λΌμ΄μ–ΈνΈμ ν¬νΈ λ²νΈ
- `443`: λ©μ μ§€ μ„λ²„μ ν¬νΈ λ²νΈ
- `\r\n`: μ¤„ λ°”κΏ λ¬Έμ

</td>
<td>

Proxy Protocol v2λ” λ°”μ΄λ„λ¦¬ ν•μ‹μ΄λ©°, λ” μ»΄ν©νΈν•κ³  ν¨μ¨μ .

λ‹¤μκ³Ό κ°™μ€ ν•μ‹μ„ κ°€μ§:

- **Source address** β€“ μ›λ³Έ μ£Όμ†. μ—°κ²°μ„ μ‹μ‘ν• ν΄λΌμ΄μ–ΈνΈμ μ›λ³Έ IP μ£Όμ†
- **Destination address** β€“ λ©μ μ§€ μ£Όμ†. μ—°κ²°μ„ μμ‹ ν•λ” ν”„λ΅μ‹ λλ” λ΅λ“ λ°Έλ°μ„μ IP μ£Όμ†
- **Source port** β€“ μ›λ³Έ ν¬νΈ. ν΄λΌμ΄μ–ΈνΈ μΈ΅μ—μ„ μ—°κ²°μ΄ μ‹μ‘λλ” ν¬νΈ λ²νΈ
- **Destination port** β€“ λ©μ μ§€ ν¬νΈ. ν”„λ΅μ‹ λλ” λ΅λ“ λ°Έλ°μ„ μΈ΅μ—μ„ μ—°κ²°μ΄ μ§€ν–¥λλ” ν¬νΈ λ²νΈ
- **Protocol** β€“ ν”„λ΅ν† μ½. μ—°κ²°μ— μ‚¬μ©λλ” λ„¤νΈμ›ν¬ ν”„λ΅ν† μ½ (μ: TCP λλ” UDP)
- **Version** β€“ λ²„μ „. μ‚¬μ©λλ” Proxy Protocolμ λ²„μ „ (μ: v2)
- **Family** β€“ μ£Όμ† ν¨λ°€λ¦¬. μ›λ³Έ λ° λ©μ μ§€ IP μ£Όμ†μ μ£Όμ† ν¨λ°€λ¦¬ (μ: IPv4 λλ” IPv6)
- **Length** β€“ κΈΈμ΄. Proxy Protocol ν—¤λ”μ κΈΈμ΄
- **Checksum** β€“ μ²΄ν¬μ„¬. ν—¤λ”μ λ¬΄κ²°μ„±μ„ λ³΄μ¥ν•κΈ° μ„ν• μ²΄ν¬μ„¬ κ°’
- **Type-length-value (TLV)** β€“ νƒ€μ… κΈΈμ΄ κ°’. λ§μ¶¤ν• λ°μ΄ν„° (μ: κ°€μƒ ν”„λΌμ΄λΉ— ν΄λΌμ°λ“(VPC) μ—”λ“ν¬μΈνΈ ID)

μ„ μ •λ³΄λ“¤μ€ Proxy Protocol v2 ν—¤λ”μ— μΈμ½”λ”©λμ–΄ μμΌλ©°,
ν”„λ΅μ‹ λλ” λ΅λ“ λ°Έλ°μ„κ°€ λ°±μ—”λ“ μ„λ²„μ—κ² ν΄λΌμ΄μ–ΈνΈ μ—°κ²° μ •λ³΄λ¥Ό μ •ν™•ν•κ² μ „λ‹¬ν•λ” λ° μ‚¬μ©.

Proxy Protocol v2λ” λ°”μ΄λ„λ¦¬ ν•μ‹μ΄κΈ° λ•λ¬Έμ— μ‚¬λμ΄ μ§μ ‘ μ½κΈ° μ–΄λ µμ§€λ§, ν¨μ¨μ„±κ³Ό ν™•μ¥μ„±μ„ μ κ³µ.

μ΄λ¥Ό ν†µν•΄ μ„λ²„λ” ν΄λΌμ΄μ–ΈνΈμ μ›λ IP μ£Όμ† λ° ν¬νΈ λ²νΈλ¥Ό μ• μ μκ³ , μ΄λ¥Ό κΈ°λ°μΌλ΅ λ΅κΉ…μ΄λ‚ μ ‘κ·Ό μ μ–΄λ¥Ό ν•  μ μμ

</td></tr></table>

<br/>

## Proxy Protocol

- **CLB**λ” **Proxy Protocol λ²„μ „ 1**μ„ μ‚¬μ©ν•κ³  **NLB**λ” **Proxy Protocol λ²„μ „ 2**λ¥Ό μ‚¬μ©
- **Network Load Balancerμ κ²½μ°**:
  - **μΈμ¤ν„΄μ¤ ID λ° ECS μ‘μ—…μ΄ μλ” νƒ€κ²**: ν΄λΌμ΄μ–ΈνΈμ μ†μ¤ IPκ°€ λ³΄μ΅΄λ¨ β­•οΈ
  - **IP μ£Όμ†κ°€ μλ” νƒ€κ²**:
    - **TCP λ° TLS**: ν΄λΌμ΄μ–ΈνΈμ μ†μ¤ IPκ°€ λ³΄μ΅΄λμ§€ μ•μ β, Proxy Protocolμ„ ν™μ„±ν™”ν•΄μ•Ό ν•¨
    - **UDP λ° TCP_UDP**: ν΄λΌμ΄μ–ΈνΈμ μ†μ¤ IPκ°€ λ³΄μ΅΄λ¨ β­•οΈ
- λ΅λ“ λ°Έλ°μ„λ” ν”„λ΅μ‹ μ„λ²„ λ’¤μ— μμ–΄μ„λ” μ• λ¨, κ·Έλ ‡μ§€ μ•μΌλ©΄ λ°±μ—”λ“κ°€ μ¤‘λ³µ κµ¬μ„± μ •λ³΄λ¥Ό μμ‹ ν•μ—¬ μ¤λ¥κ°€ λ°μƒν•  μ μμ
- ν”„λ΅μ‹ ν”„λ΅ν† μ½μ€ Application Load Balancerλ¥Ό μ‚¬μ©ν•  λ• ν•„μ”ν•μ§€ μ•μ, ALBλ” μ΄λ―Έ HTTP `X-Forwarded-For` ν—¤λ”λ¥Ό μ‚½μ…ν•¨

β οΈ Proxy Protocolμ€ μ¤μ§ NLBκ°€ IP μ£Όμ†κ°€ μλ” νƒ€κ²μ TCP/TLSλ΅ μ—°κ²°λ  λ• μ‚¬μ©λ¨

<br/>

<table><tr><td>

### Network Load Balancer: Hots-based targets vs. IP-based targets

#### Hots-based Targets
- NLBκ°€ νΉμ • μ„λ²„λ‚ μ»¨ν…μ΄λ„λ΅ λ°μ΄ν„°λ¥Ό λ³΄λ‚Ό λ•, NLBλ” κ·Έ μ„λ²„λ‚ μ»¨ν…μ΄λ„μ— μ§μ ‘ μ—°κ²°.
- **μ†μ¤ IP λ³΄μ΅΄**: ν΄λΌμ΄μ–ΈνΈμ μ›λ IP μ£Όμ†λ¥Ό κ·Έλ€λ΅ μ μ§€. μ„λ²„λ” ν΄λΌμ΄μ–ΈνΈμ μ§„μ§ IP μ£Όμ†λ¥Ό λ³Ό μ μμ.

#### IP-based Targets
- νƒ€κ²μ΄ IP μ£Όμ†μΈ κ²½μ°, NLBλ” μ§€μ •λ IP μ£Όμ†λ΅ νΈλν”½μ„ μ „λ‹¬. μ΄ IP μ£Όμ†λ” μ„λ²„λ‚ λ‹¤λ¥Έ λ„¤νΈμ›ν¬ μ¥μΉμΌ μ μμ.
- **μ†μ¤ IP λ³΄μ΅΄**:
  - **TCP λ° TLS ν”„λ΅ν† μ½**: 
    - NLBκ°€ ν¨ν‚·μ„ μμ •ν•΄ νƒ€κ² IPλ΅ μ „λ‹¬
    - λ•λ¬Έμ—, κΈ°λ³Έμ μΌλ΅ ν΄λΌμ΄μ–ΈνΈμ IP μ£Όμ†κ°€ μ μ§€λμ§€ μ•μ
    - μ„λ²„λ” ν΄λΌμ΄μ–ΈνΈ IP λ€μ‹  NLBμ IP μ£Όμ†λ¥Ό λ΄„
    - μ›λ IP μ£Όμ†λ¥Ό λ³΄μ΅΄ν•λ ¤λ©΄ νΉλ³„ν• μ„¤μ •(Proxy Protocol)μ„ ν•΄μ•Ό ν•¨
  - **UDP λ° TCP_UDP ν”„λ΅ν† μ½**:
    - ν΄λΌμ΄μ–ΈνΈμ IP μ£Όμ†κ°€ κ·Έλ€λ΅ μ μ§€
    - μ„λ²„λ” ν΄λΌμ΄μ–ΈνΈμ μ§„μ§ IP μ£Όμ†λ¥Ό λ³Ό μ μμ

</td></tr></table>
