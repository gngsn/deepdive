# CNI in Kubernetes
_Container Networking Interface_

ì¿ ë²„ë„¤í…ŒìŠ¤ëŠ” ì»¨í…Œì´ë„ˆ Network Namespace ìƒì„±ì„ ì±…ì„ì§

ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë“¤ì„ ì‹ë³„í•˜ê³  ì ì ˆí•œ ë„¤íŠ¸ì›Œí¬ í”ŒëŸ¬ê·¸ì¸ì„ ë¶ˆëŸ¬ì„œ ì•Œë§ì€ ë„¤íŠ¸ì›Œí¬ì— ë¶™ì„

ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œ ì»¨í…Œì´ë„ˆì˜ ìƒì„±ì„ ì±…ì„ì§€ëŠ” ì»´í¬ë„ŒíŠ¸ëŠ” ì»¨í…Œì´ë„ˆê°€ ìƒì„±ëœ ì´í›„ ë°”ë¡œ CNI í”ŒëŸ¬ê·¸ì¸ì„ ë¶ˆëŸ¬ì•¼ í•¨

CNI í”ŒëŸ¬ê·¸ì¸ì€ í´ëŸ¬ìŠ¤í„°ì˜ ê° ë…¸ë“œì˜ kubelet service ë‚´ì— ì„¤ì •ë¨

kubelet ì„¤ì • íŒŒì¼ì„ í™•ì¸í•´ë³´ë©´ ì•„ë˜ì—ì„œ ì„¤ì • ê°’ë“¤ì„ í™•ì¸í•  ìˆ˜ ìˆìŒ 

<pre><code lang="bash"># kubelet.service
ExecStart=/usr/local/bin/kubelet \\
--config=/var/lib/kubelet/kubelet-config.yaml \\
--container-runtime=remote \\
--container-runtime-endpoint=unix:///var/run/containerd/containerd.sock \\
--image-pull-progress-deadline=2m \\
--kubeconfig=/var/lib/kubelet/kubeconfig \\
<b>--network-plugin=cni \\
--cni-bin-dir=/opt/cni/bin \\
--cni-conf-dir=/etc/cni/net.d</b> \\
--register-node=true \\
--v=2
</code></pre>

ë™ì¼í•œ Network Plugin ì„¤ì • ì •ë³´ë¥¼ kubelet ì‹¤í–‰ ì •ë³´ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŒ

<pre><code lang="bash">$ ps -aux | grep kubelet
root 2095 1.8 2.4 960676 98788 ? Ssl 02:32 0:36 /usr/bin/kubelet --bootstrapkubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --
config=/var/lib/kubelet/config.yaml --cgroup-driver=cgroupfs <b>--cni-bin-dir=/opt/cni/bin --cni-conf-dir=/etc/cni/net.d --network-plugin=cni</b>
</code></pre>

- `cni-bin-dir` ëŠ” ì‹¤í–‰ ê°€ëŠ¥í•œ CNI í”ŒëŸ¬ê·¸ì¸ì„ ì§€ì›í•˜ëŠ” ëª¨ë“  ê²ƒì„ í¬í•¨
  - ìœ„ íŒŒë¼ë¯¸í„°ëŠ” Kubernetes 1.24 ë¶€í„° ì œê±°ë¨, with management of the CNI no longer in scope for kubelet [[ğŸ”— link](https://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/#installation)]
- `cni-conf-dir` ëŠ” ì–´ë–¤ í”ŒëŸ¬ê·¸ì¸ì´ í•„ìš”í•œì§€ ì°¾ì„ ë•Œ kubeletì´ í›‘ì–´ë³´ëŠ” ìœ„ì¹˜   

```
$ ls /opt/cni/bin
bridge dhcp flannel host-local ipvlan loopback macvlan portmap ptp sample tuning
vlan weave-ipam weave-net weave-plugin-2.2.1

$ ls /etc/cni/net.d
10-bridge.conf

# CNI í‘œì¤€ ì •ì˜ íŒŒì¼
$ cat /etc/cni/net.d/10-bridge.conf
{
    "cniVersion": "0.2.0",
    "name": "mynet",
    "type": "bridge",
    "bridge": "cni0",
    "isGateway": true,
    "ipMasq": true,
    "ipam": {
        "type": "host-local",
        "subnet": "10.22.0.0/16",
        "routes": [
            { "dst": "0.0.0.0/0" }
        ]
    }
}
```

[CNI Configuration format](https://github.com/containernetworking/cni/blob/main/SPEC.md)

A network configuration consists of a JSON object with the following keys:

- `cniVersion` (string): [Semantic Version 2.0](https://semver.org/) of CNI specification to which this configuration list and all the individual configurations conform. Currently "1.1.0"
- `cniVersions` (string list): List of all CNI versions which this configuration supports. See version selection below.
- `name` (string): Network name. This should be unique across all network configurations on a host (or other administrative domain). Must start with an alphanumeric character, optionally followed by any combination of one or more alphanumeric characters, underscore, dot (.) or hyphen (-).
- `disableCheck` (boolean): Either true or false. If disableCheck is true, runtimes must not call CHECK for this network configuration list. This allows an administrator to prevent CHECKing where a combination of plugins is known to return spurious errors.
- `plugins` (list): A list of CNI plugins and their configuration, which is a list of plugin configuration objects.

Plugin configuration objects:
Plugin configuration objects may contain additional fields than the ones defined here. The runtime MUST pass through these fields, unchanged, to the plugin, as defined in section 3.

**Required keys:**

- `type` (string): Matches the name of the CNI plugin binary on disk. Must not contain characters disallowed in file paths for the system (e.g. / or \).

**Optional keys, used by the protocol:**

- `capabilities` (dictionary): Defined in section 3

**Reserved keys, used by the protocol**: These keys are generated by the runtime at execution time, and thus should not be used in configuration.

- `runtimeConfig`
- `args`
- Any keys starting with `cni.dev/`

**Optional keys, well-known**: These keys are not used by the protocol, but have a standard meaning to plugins. Plugins that consume any of these configuration keys should respect their intended semantics.

- `ipMasq` (boolean): If supported by the plugin, sets up an IP masquerade on the host for this network. This is necessary if the host will act as a gateway to subnets that are not able to route to the IP assigned to the container.
- `ipam` (dictionary): Dictionary with IPAM (IP Address Management) specific values:
  - `type` (string): Refers to the filename of the IPAM plugin executable. Must not contain characters disallowed in file paths for the system (e.g. / or \).
- `dns` (dictionary, optional): Dictionary with DNS specific values:
  - `nameservers` (list of strings, optional): list of a priority-ordered list of DNS nameservers that this network is aware of. Each entry in the list is a string containing either an IPv4 or an IPv6 address.
  - `domain` (string, optional): the local domain used for short hostname lookups.
  - `search` (list of strings, optional): list of priority ordered search domains for short hostname lookups. Will be preferred over domain by most resolvers.
  - `options` (list of strings, optional): list of options that can be passed to the resolver
  - `Other` keys: Plugins may define additional fields that they accept and may generate an error if called with unknown fields. Runtimes must preserve unknown fields in plugin configuration objects when transforming for execution.